{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"all.js","sourcesContent":["const VERSION = 'v16.05.1'\n\nimport 'babel-polyfill';\nimport _ from 'lodash';\nimport chalk from 'chalk';\nconst Table = require('cli-table');\n\nfunction populate(votes) {\n  let populated = [];\n  for (let vote of votes) {\n    Array(vote[0]).fill(vote[1]).forEach(v => populated.push(v));\n  }\n  return populated;\n}\n\nNumber.prototype.round = function(places) {\n  return +(Math.round(this + 'e+' + places)  + 'e-' + places);\n}\n\n/**\n * A single transferrable vote, containing an array of names of candidates\n * (`string`s) in order of preference indicated, i.e. first-preference vote is\n * at index `0`.\n * @typedef {string[][]} vote\n */\n\n/**\n * Counts a candidate's votes in a position on ranked ballot\n * @param {number} pref The position of preference at which the votes for the\n * candidate is counted, e.g. `pref = 1` to count first-preference votes\n * @param {string} cand Name of the candidate\n * @param {vote[]} votes Votes to be counted\n * @returns {number} Number of votes the candidate receives at the specified\n * position on the ballot\n */\nfunction countPref(pref, cand, votes) {\n  let count = 0;\n  votes.forEach((v, i, arr) => {\n    if (v[pref - 1] === cand) count++;\n  });\n  return count;\n}\n\nfunction getPref(pref, cand, votes) {\n  let count = [];\n  votes.forEach((v, i, arr) => {\n    if (v[pref - 1] === cand) count.push(i);\n  });\n  return count;\n}\n\n/**\n * Does a round of counting for STV\n * @param  {vote[]} votes    Votes to be counted\n * @param  {number} seats    Number of seats available\n * @param  {number} [quota] Quota needed to declared a candidate elected;\n * defaults to Droop quota calculated from `votes.length` and `seats`\n * @param  {string[]} hopefuls List of candidates to be counted, i.e. neither\n * elected nor eliminated\n * @param  {string[]} eliminated List of candidates eliminated from counting\n * @param  {string[]} elected  List of already elected candidates\n * @param  {Object[]} counts   History of votes received by the candidates in\n * previous rounds\n * @param  {Object} [surplus = {}] Surplus votes to be redistributed from last\n * round; defaults to `{}`\n * @return {string[]}          List of all elected candidates after this round\n */\nfunction round(votes, values, seats, quota = -1, hopefuls, eliminated, elected,\n  counts, surplus = {}) {\n  if (elected.length === seats) {\n    console.log('<all vacancies filled>')\n    console.log('********** COUNTING ENDS **********');\n    return {\n      elected,\n      counts,\n    }\n  }\n\n  if (hopefuls.length <= seats - elected.length) {\n    console.log('<remaining candidates can fill all vacancies>')\n    hopefuls.forEach(v => {\n      elected.push(v);\n      console.log(chalk.white.bgGreen('----- elected', v, '-----'));\n    });\n    console.log('********** COUNTING ENDS **********');\n    return {\n      elected,\n      counts,\n    };\n  }\n\n  console.log('---------- ROUND', counts.length + 1, '----------');\n\n  if (quota === -1) {\n    quota = Math.floor(votes.length / (seats + 1) + 1);\n  }\n  let distributed = {};\n  if (Object.keys(surplus).length > 0) {\n    distributed = distributeSurplus(votes, values, counts[counts.length - 1],\n      surplus);\n    surplus = {};\n  }\n\n  let roundCount = {};\n  let roundElected = [];\n  let hasElected = false;\n\n  for (let v of hopefuls) {\n    let count = 0;\n    if (counts.length === 0) {\n      count = countPref(1, v, votes);\n    } else {\n      count = distributed[v];\n    }\n    roundCount[v] = count;\n    if (count >= quota) {\n      roundElected.push(v);\n      elected.push(v);\n      hopefuls = hopefuls.filter(h => h !== v);\n    }\n  }\n\n  counts.push(roundCount);\n  console.log('+++++ round count +++++');\n  roundCountTable(roundCount);\n\n  let excluded = [...elected, ...eliminated];\n  if (roundElected.length === 0) {\n    let elimCand = eliminate(votes, values, '', roundCount, hopefuls, excluded,\n    surplus, counts);\n    eliminated.push(elimCand);\n    hopefuls = hopefuls.filter(v => v !== elimCand);\n    console.log(chalk.gray.bgYellow('----- eliminated', elimCand, '-----'));\n  } else {\n    roundElected.forEach(v => {\n      console.log(chalk.white.bgGreen('----- elected', v, '-----'));\n      eliminate(votes, values, v, roundCount, hopefuls, excluded, surplus,\n        counts, roundCount[v] - quota);\n    });\n  }\n\n  if (counts.length < 20) {} else {return;}\n  return round(votes, values, seats, quota, hopefuls, eliminated, elected,\n    counts, surplus);\n}\n\nfunction countSurplus(votes, values, candidate, hopefuls, excluded) {\n  let surplus = {};\n  let transferred = _.cloneDeep(votes).map((val, ind, arr) => {\n    if (val[0] === candidate) return val;\n    return [];\n  });\n  let total = transferred.length;\n\n  for (let exclude of excluded) {\n    transferred.forEach((val, ind, arr) => {\n      transferred[ind] = val.filter(v => v !== exclude);\n    });\n  }\n\n  for (let hopeful of hopefuls) {\n    surplus[hopeful] = getPref(1, hopeful, transferred);\n  }\n\n  return {\n    dist: surplus\n  };\n}\n\nfunction distributeSurplus(votes, values, lastCounts, surplus) {\n  let count = Object.assign({}, lastCounts);\n  let totalTransferred = {};\n  for (let candidate in surplus) {\n    if (surplus.hasOwnProperty(candidate)) {\n      totalTransferred = 0;\n      let tableCount = {};\n      let dist = surplus[candidate].dist;\n      if(surplus[candidate].surplus < count[candidate]) {\n        if(count[candidate] > 0) {\n          let value = surplus[candidate].surplus / count[candidate];\n          for (let transfer in dist) {\n            if (dist.hasOwnProperty(transfer)) {\n              for (let nextPref of dist[transfer]) {\n                values[nextPref] *= value;\n              }\n            }\n          }\n        }\n      }\n\n      console.log(chalk.magenta('----- distributing surplus -----'));\n      for (let transfer in dist) {\n        if (dist.hasOwnProperty(transfer)) {\n          tableCount[transfer] = 0;\n          for (let nextPref of dist[transfer]) {\n            count[transfer] += values[nextPref];\n\n            tableCount[transfer] += values[nextPref];\n            totalTransferred += values[nextPref];\n          }\n          count[transfer] = count[transfer].round(PRECISION);\n        }\n      }\n\n      console.log(chalk.bold(candidate));\n      for (let transfer in tableCount) {\n        if (tableCount[transfer])\n          console.log('- transfers', chalk.underline(tableCount[transfer]),\n            'votes to', chalk.underline(transfer));\n      }\n\n      console.log('-', chalk.bold('Transfer in total:'),\n        chalk.underline(totalTransferred), chalk.bold('Exhausted:'),\n        chalk.underline(surplus[candidate].surplus - totalTransferred));\n\n    }\n  }\n  return count;\n}\n\nfunction eliminate(votes, values, candidate, roundCount, hopefuls, excluded,\nsurplus, counts, surplusVotes = null) {\n\n  if (candidate === '') {\n    candidate = Object.keys(roundCount);\n    let minVotes = _.min(_.values(roundCount));\n    let potentials = [];\n    candidate.forEach(function(val, ind) {\n      if (roundCount[val] === minVotes) {\n        potentials.push(ind);\n      }\n    });\n    if (potentials.length <= 0)\n      console.error('********** unable to continue elimination **********');\n    if (potentials.length === 1) {\n      candidate = candidate[potentials[0]];\n    } else {\n      let potentialCands = [];\n      for (let ind of potentials) {\n        potentialCands.push(candidate[ind])\n      }\n      candidate = breakTie(potentialCands, counts);\n    }\n    excluded.push(candidate);\n    hopefuls = hopefuls.filter(v => v !== candidate);\n  }\n\n  surplus[candidate] = countSurplus(votes, values, candidate, hopefuls,\n    excluded);\n  surplus[candidate].surplus = surplusVotes !== null ?\n    surplusVotes : roundCount[candidate];\n\n  votes.forEach((val, ind, arr) => {\n    votes[ind] = val.filter(v => v !== candidate);\n  });\n\n  return candidate;\n}\n\n/**\n * Breaks a tie in elimination step by returning the candidate with lowest\n * number of votes in the last round; if fails to break after counting all\n * previous rounds, a random candidate is returned\n * @param  {string[]} potentials List of tied candidates\n * @param  {Object[]} counts     History of votes received by the candidates in\n * previous rounds\n * @return {string}            Candidate to be eliminated after breaking the tie\n */\nfunction breakTie(potentials, counts) {\n  console.log('*a tie!*');\n  if (counts.length > 0) {\n    let lastCount = counts[counts.length - 1];\n    let lastCounts = _.pick(lastCount, potentials);\n    let minVotes = _.min(_.values(lastCounts));\n    let potentialsTie = [];\n    potentials.forEach(function(val, ind) {\n      if (lastCounts[val] === minVotes) {\n        potentialsTie.push(ind);\n      }\n    });\n    if (potentialsTie.length <= 0)\n      console.error('********** unable to continue elimination **********');\n    if (potentialsTie.length === potentials.length) {\n      let against = potentials[Math.floor(Math.random() * potentials.length)];\n      console.log('----- tie randomly broken against', against, '-----');\n      return against;\n    }\n    if (potentialsTie.length === 1) {\n      let against = potentials[potentialsTie[0]];\n      console.log('----- tie broken against', against, '-----');\n      return against;\n    }\n    let potentialCands = [];\n    for (let ind in potentialsTie) {\n      potentialCands.push(potentials[ind])\n    }\n    return breakTie(potentialCands, counts.slice(0, -1));\n  }\n}\n\nfunction count({votes, candidates, seats, quota}) {\n  console.log(chalk.underline('stvCount', VERSION, '(c) Z. Tong Zhang\\n'));\n  console.log('********** COUNTING STARTS **********')\n\n  if (quota < 0) quota = Math.floor(votes.length / (seats + 1) + 1);\n  let values = new Array(votes.length).fill(1);\n  let result = round(votes, values, seats, quota, candidates, [], [], []);\n\n  console.log('votes #:', votes.length);\n  console.log('quota:', quota);\n  countsTable(result.counts, result.elected);\n\n  let elected = new Table({head: [chalk.bold.green('ELECTED')]});\n  result.elected.forEach(v => elected.push([v]));\n  console.log(elected.toString());\n\n  return result;\n}\n\nfunction roundCountTable(roundCount) {\n  let table = new Table();\n  for(let candidate in roundCount) {\n    table.push({\n      [chalk.cyan.bold(candidate)]: roundCount[candidate],\n    });\n  }\n  return console.log(table.toString());\n}\n\nfunction countsTable(counts, elected) {\n  const isElected = candidate => elected.includes(candidate) ?\n    chalk.bold.green('✓') : chalk.bold.red('✗');\n  let table = new Table({\n    head: [chalk.blue.bold('Round'), ...Array.from(new Array(counts.length),\n      (x, i) => chalk.blue.bold(i + 1)), chalk.bold.green('Elected')],\n  });\n\n  for (let candidate in counts[0]) {\n    table.push({\n      [chalk.cyan.bold(candidate)]: [...Array.from(new Array(counts.length),\n        (x, i) => candidate in counts[i] ?\n          counts[i][candidate] : isElected(candidate)),\n        isElected(candidate)],\n    })\n  }\n\n  return console.log(table.toString());\n}\n\nlet options = require('../options.json');\nconst PRECISION = options.precision || 6;\nconst Converter = require('csvtojson').Converter;\nlet converter = new Converter({});\n\nconverter.on('end_parsed', jsonArray => {\n  let votes = [];\n  let ind = 0;\n  for (let vote of jsonArray) {\n    vote = _.pickBy(vote, _.identity);\n    let voteArray = Object.keys(vote).sort((a, b) => vote[a] - vote[b]);\n    let temp = [];\n    for (let i of voteArray)\n      i && temp.push(i);\n\n    voteArray = temp;\n    votes[ind++] = voteArray;\n  }\n  options.votes = votes;\n  count(options);\n});\n\nrequire('fs').createReadStream('./votes.csv').pipe(converter);\n"],"sourceRoot":"/source/"}